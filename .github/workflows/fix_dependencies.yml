name: Fix Library Name and Build

on:
  workflow_dispatch:

jobs:
  fix-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Fix Script
        run: |
          cat > fix_final.sh <<'EOF'
          #!/bin/bash
          echo "Aplicando correcoes..."
          
          # Sobrescreve CMakeLists.txt com a versao correta (target 'nes')
          cat > CMakeLists.txt <<'CMAKE'
          cmake_minimum_required(VERSION 3.22.1)
          project(nes C)
          set(SRC_DIR ${CMAKE_CURRENT_SOURCE_DIR}/src)
          set(LUA_DIR ${SRC_DIR}/lua)
          set(EXTERNAL_DIR ${CMAKE_CURRENT_SOURCE_DIR}/external)
          add_subdirectory(${EXTERNAL_DIR}/SDL)
          add_subdirectory(${EXTERNAL_DIR}/SDL_ttf)
          file(GLOB LUA_SOURCES "${LUA_DIR}/*.c")
          list(REMOVE_ITEM LUA_SOURCES "${LUA_DIR}/lua.c" "${LUA_DIR}/luac.c")
          add_library(lua STATIC ${LUA_SOURCES})
          target_include_directories(lua PUBLIC ${LUA_DIR})
          target_compile_definitions(lua PRIVATE LUA_USE_LINUX LUA_USE_C89)
          set(NES_SOURCES ${SRC_DIR}/main.c ${SRC_DIR}/emulator.c ${SRC_DIR}/cpu6502.c ${SRC_DIR}/ppu.c ${SRC_DIR}/apu.c ${SRC_DIR}/mmu.c ${SRC_DIR}/mappers/mapper.c ${SRC_DIR}/mappers/uxrom.c ${SRC_DIR}/mappers/mmc1.c ${SRC_DIR}/mappers/cnrom.c ${SRC_DIR}/mappers/gnrom.c ${SRC_DIR}/mappers/axrom.c ${SRC_DIR}/mappers/mmc3.c ${SRC_DIR}/mappers/colordreams.c ${SRC_DIR}/controller.c ${SRC_DIR}/gamepad.c ${SRC_DIR}/gfx.c ${SRC_DIR}/timers.c ${SRC_DIR}/utils.c ${SRC_DIR}/nsf.c ${SRC_DIR}/genie.c ${SRC_DIR}/debugtools.c ${SRC_DIR}/biquad.c ${SRC_DIR}/touchpad.c ${SRC_DIR}/lua_bridge.c)
          
          # LIBRARY NAME: nes (Gera libnes.so)
          add_library(nes SHARED ${NES_SOURCES})
          
          target_include_directories(nes PRIVATE ${SRC_DIR} ${SRC_DIR}/mappers ${LUA_DIR} ${EXTERNAL_DIR}/SDL/include ${EXTERNAL_DIR}/SDL/include/SDL3 ${EXTERNAL_DIR}/SDL_ttf/include ${EXTERNAL_DIR}/SDL_ttf/include/SDL3_ttf)
          target_compile_definitions(nes PRIVATE ANDROID DEBUGGING_ENABLED)
          target_link_libraries(nes PRIVATE SDL3::SDL3 SDL3_ttf::SDL3_ttf lua android log m)
          CMAKE
          
          echo "Correcoes aplicadas."
          EOF

      - name: Run Fix Script
        run: |
          chmod +x fix_final.sh
          ./fix_final.sh
          rm fix_final.sh

      - name: Commit changes
        run: |
          git config --global user.name "FixBot"
          git config --global user.email "bot@example.com"
          git add CMakeLists.txt
          git commit -m "Fix: Rename lib to libnes.so and fix includes" || echo "No changes to commit"
          git push
